$\newcommand{\V}[1]{\boldsymbol{#1}}$

# 5. パーティクル<br />フィルタによる<br />自己位置推定

千葉工業大学 上田 隆一

<br />

<p style="font-size:50%">
This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
<img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a>
</p>

---

## 5.1 自己位置推定の問題と解法

* <span style="color:red">自己位置推定</span>
    * ロボットが自らの姿勢（位置と向き）を、これまで得た情報から推定すること
        * おさらい 
            * 位置: $(x,y)$
            * 向き: $\theta$
            * 姿勢・状態: $\V{x} = (x\ y \ \theta)^\top$<br />　
    * ロボットにとって基本的な問題
        * 位置情報がないとプログラムが大変（できないことはないけど）
        * 新しいセンサが出るたびに新しい課題

今も重要な研究対象

---

## 5.1.1 計算すべき確率分布と<br />利用できる情報

数式で考えていきましょう

---

### 自己位置推定に使える情報


* $\V{x}_0$: 最初の姿勢（分かっているとしましょう）<br />　
* $\V{u}_\{1:t\}$: 各時刻の制御指令
    * $\V{u}_\{1:t\}$というのは$\V{u}_1, \V{u}_2, \dots, \V{u}_t$の略記<br />　
* $\textbf{z}_\{1:t\}$: 各時刻のセンサ値のリスト
    * $\textbf{z}_\{1:t\}$というのは$\textbf{z}_1, \textbf{z}_2, \dots, \textbf{z}_t$の略記
    * $\textbf{z}_t$には各ランドマークからのセンサ値（入っていないことも）<br />　
* $p(\V{x} | \V{x}_{t-1}, \V{u}\_t)$: 状態遷移モデル
* $p(\textbf{z} | \V{x})$: 観測モデル

数式で考えるとこれしかない

---

### 計算すべき確率分布

* 計算すべきは姿勢ではなく<span style="color:red">姿勢の分布</span>
    * 姿勢だけ求めても、不確かさが表現できない<br />　
* 計算すべき分布: <span style="color:red">$p_t(\V{x} | \V{x}_0, \V{u}_\{1:t\}, \textbf{z}_\{1:t\})$</span>
    * $\V{x}_t^*$: 真の姿勢
    * 自己位置推定問題: 初期姿勢と、これまでの制御出力、<br />センサ値から分布を計算する問題

---

## 5.1.2 信念

* 「計算すべき分布」に特別に$b_t$と記号を与えましょう
    * $b_t(\V{x}) = p_t(\V{x} | \V{x}_0, \V{u}_\{1:t\}, \textbf{z}_\{1:t\})$
        * $XY\theta$空間中の確率分布（下図(a)）
        * ロボットは(b)の世界が見えない。頭の中の(a)だけ
<img width="70%" src="figs/belief.jpg" />
* $b_t$を<span style="color:red">信念（信念分布）</span>と呼ぶ
    * 自己の姿勢に対するロボットの考え
        * 姿勢だけでなく不確かさも表現（次ページ）


---

### 様々な信念と、それの意味するもの

<img width="100%" src="figs/various_beliefs.jpg" />

多様な判断が可能に（難しいが。12章で詳しく）

---

## 5.1.3 信念の演算

* 以下の手順を踏む
    * 初期の信念$b_0$を与える
        * 本章では$\V{x}_0$が分かっているので、$\V{x}_0$まわりの急峻な分布に
        * 以後、情報が入るごとに信念を更新して$b_1, b_2, \dots, b_t$と求めていく
            * ロボットが移動したら更新
            * ロボットがランドマークを観測したら更新

計算式を導出しましょう

---

### ロボットが移動したときの演算

* $b_\{t-1\}$に新たに$\V{u}_t$の情報が加わる
    * $b_{t-1}(\V{x}) \rightarrow b_{t-1}(\V{x}|\V{u}_t)$<br />　
* $\hat{b}\_t = b_{t-1}(\V{x}|\V{u}_t)$としましょう
    * $b_t$との違い: $\textbf{z}_t$の情報がまだない


$\hat{b}\_t$を$b_{t-1}$からどう計算すればよいでしょう？

<!--* $\hat{b}_t(\V{x}) = p(\V{x} = \V{x}_t^* | \V{x}_0, \V{u}_\{1:t\}, \textbf{z}_\{1:t-1\})$-->

---

### $b_{t-1}$と$\hat{b}\_t$の関係

* 考え方
    * 例えば時刻$t-1$においてロボットの姿勢が$\V{x}'$である場合、<br />$\V{u}\_t$によって、次状態が状態遷移モデルで$p(\V{x} | \V{x}', \V{u}\_t)$に分布
        * 信念$b_{t-1}$によると、$\V{x}'$に存在する確率の密度は$b_{t-1}(\V{x}')$
        * 密度$b_{t-1}(\V{x}')$が状態遷移によって拡散
    * $\V{x}'$を状態空間からくまなく選んで密度$b_{t-1}(\V{x}')$を動かし、<br />拡散した密度をある姿勢$\V{x}$で積算すると$\hat{b}_t(\V{x})$に（次ページ）

<img width="50%" src="figs/mcl_motion_update.jpg" />

---

### $\hat{b}\_t$の計算式

* 前ページの操作を式に
    * $\hat{b}\_t(\V{x}) = \int\_{\V{x}' \in \mathcal{X}} p(\V{x} | \V{x}', \V{u}\_t) b\_{t-1}(\V{x}')  d\V{x}'$
        * $\boldsymbol{x}'$を状態遷移モデルで動かして密度を積分<br />　
* 次のようにも書ける
    * $\hat{b}\_t(\V{x}) =  \big\langle p(\V{x} | \V{x}', \V{u}_t) \big\rangle_\{b_\{t-1\}(\V{x}')\}$ 
        * $b_{t-1}$のときに状態遷移モデルから得られる次状態の密度の期待値を$\boldsymbol{x}'$で計算すると$\hat{b}_t(\boldsymbol{x})$になる<br />　
* 筆者は「マルコフ連鎖の式」などと言っている
    * マルコフ性: 次状態が直前の姿勢と制御出力だけから決まって、それ以前の状態は情報として不要という性質を指す
        * $p(\V{x} | \V{x}', \V{u}\_t)$がそうなっている

---

## 5.2 パーティクルの準備

---

## 5.3 移動後のパーティクルの<br />姿勢更新

---

## 5.3.1 パーティクルの移動のための状態遷移モデル


---

## 5.1 自己位置推定の問題と解法


---

## 5.1.1 計算すべき確率分布と利用できる情報


---

## 5.1.2 信念


---

## 5.1.3 信念の演算

---

## 5.2 パーティクルの準備

---

## 5.3 移動後のパーティクルの姿勢更新

---

## 5.3.1 パーティクルの移動のための状態遷移モデル


---

## 5.3.2 状態遷移モデルの実装


---

## 5.3.3 パラメータの調整


---

## 5.3.4 求めたパラメータによる動作確認


---

## 5.4 観測後のセンサ値の反映


---

## 5.4.1 準備 



---

## 5.4.2 センサ値によるパーティクルの姿勢の評価



---

## 5.4.3 パーティクルの重み


---

## 5.4.4 尤度関数の決定



---

## 5.4.5 尤度関数の実装

---

## 5.5 リサンプリング


---

## 5.5.1 単純なリサンプリングの実装


---

## 5.5.2 系統サンプリングによるリサンプリングの実装


---

## 5.6 出力の実装

---

## 5.7 まとめ
